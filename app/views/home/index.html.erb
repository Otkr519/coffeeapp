<% content_for :title, "トップページ - こそこそ珈琲研究室" %>
<%= stylesheet_link_tag "home_index.css", media: "all" %>
<div class= top>
  <div class= top_title>
    <div class= top_title_container>
      <h3 class= h3_title>お気に入りの珈琲が見つかる検索サイト</h3>
      <h1 class= h1_title>こそこそ珈琲研究室</h1>
      <%= search_form_for @q, url: search_stores_path, method: :get, class: 'search_form' do |f| %>
      <%= f.text_field :name_cont, class: 'search_box', placeholder: '店舗名で検索' %>
      <%= f.collection_select :prefecture_id_eq, Prefecture.all, :id, :name, { include_blank: 'エリアから探す' }, { class: 'search_box' } %>
      <%= f.submit '検索', class: "btn btn-success" %>
      <% end %>
    </div>
  </div>
</div>

<div class="search_container">
  <div class="country_search_text_container">
    <div class="country_search_view_text">
      <h2>Popular producing countries</h2>
      <h3>人気な生産国</h3>
    </div>
  </div>

  <section class="search_image_container">
    <%= link_to search_stores_path(q: { countries_cont: "エチオピア" }) do %>
      <div class="card">
        <img src="/assets/Ethiopia.jpg" class="card-img-top" alt="エチオピア">
        <div class="card-body">
          <h5 class="card-title">エチオピア</h5>
          <p class="card-text">華やかな香りと果実のような酸味</p>
        </div>
      </div>
    <% end %>

    <%= link_to search_stores_path(q: { countries_cont: "ブラジル" }) do %>
      <div class="card">
        <img src="/assets/Brazil.jpg" class="card-img-top" alt="ブラジル">
        <div class="card-body">
          <h5 class="card-title">ブラジル</h5>
          <p class="card-text">力強い苦味とほんのり甘い香り</p>
        </div>
      </div>
    <% end %>

    <%= link_to search_stores_path(q: { countries_cont: "コロンビア" }) do %>
      <div class="card">
        <img src="/assets/Columbia.jpg" class="card-img-top" alt="コロンビア">
        <div class="card-body">
          <h5 class="card-title">コロンビア</h5>
          <p class="card-text">酸味と甘味の絶妙なバランス</p>
        </div>
      </div>
    <% end %>

    <%= link_to search_stores_path(q: { countries_cont: "インドネシア" }) do %>
      <div class="card">
        <img src="/assets/Indonesia.jpg" class="card-img-top" alt="インドネシア">
        <div class="card-body">
          <h5 class="card-title">インドネシア</h5>
          <p class="card-text">明るい酸味と花のような甘い香り</p>
        </div>
      </div>
    <% end %>
  </section>

  <div class="button_container">
    <%= link_to '他の生産国で探す→' , search_stores_path, class: "btn btn-light btn-search"%>
  </div>
</div>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_KEY'] %>&callback=initMap"></script>

<div class="search_container">
  <div class="country_search_text_container">
    <div class="country_search_view_text">
      <h2>Search by map</h2>
        <h3>地図から探す </h3>
    </div>
  </div>
  <div class="map_container">
    <div id="map" ></div>
    <div class="map_select_details">
      <h3>選択店舗</h3>
      <div id="store_info"></div>
    </div>
  </div>
</div>

<script>
  function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 36.2048, lng: 138.2529},
      zoom: 4
    });

    var stores = <%= raw @stores.to_json(only: [:latitude, :longitude, :name, :id, :address, :countries, :image]) %>;
    var storeInfo = document.getElementById('store_info');

    stores.forEach(function(store) {
      if (!store.latitude || !store.longitude) return;

      var marker = new google.maps.Marker({
        position: {lat: store.latitude, lng: store.longitude},
        map: map,
        title: store.name
      });

      marker.addListener('click', function() {
        var imageUrl = store.image && store.image.url ? store.image.url : '/assets/default.jpg';
        var storeDetailContent = `
          <a href="/stores/${store.id}" class="store_link">
            <div class="store_item">
              <img src="${imageUrl}" class="store_image" alt="${store.name}">
              <div class="store_info">
                <h3>${store.name}</h3>
                <p>住所: ${store.address}</p>
                <p>生産国: ${store.countries}</p>
              </div>
            </div>
          </a>
        `;
        storeInfo.innerHTML = storeDetailContent;

        map.setCenter({lat: store.latitude, lng: store.longitude});
        map.setZoom(15);
      });
    });
  }
</script>
