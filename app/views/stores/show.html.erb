<% content_for :title, "#{@store.name} の詳細 - こそこそ珈琲研究室" %>
<%= stylesheet_link_tag "store_show", media: "all" %>

<div class= 'store_show_head_string'>
  店舗情報
</div>

<div class= 'store_show_container'>
  <% if @store.image? %>
    <%= image_tag @store.image.url ,  :size => '400x400', class: 'store_images' %>
  <% else %>
    <%= image_tag "/assets/default.jpg", :size => '400x400', class: 'store_images' %>
  <% end %>

  <div id="map"></div>

  <div class="store_favorite_container">
    <% if @store.liked_users.include?(current_user) %>
      <%= button_to '＊お気に入り＊', store_like_path(@store), method: :delete, class: "btn btn-success btn-sm" %>
    <% else %>
      <%= button_to 'お気に入りする', store_like_path(@store), class: "btn btn-outline-success btn-sm" %>
    <% end %>
    <p>お気に入り <span class="store_favorite_font"><%= @store.likes.count %></span>件</p>
  </div>

  <ul class="list-group list-group-flush">
    <p class= "store_show_list_font">店舗名</p>
    <li class="list-group-item"><%= @store.name%></li>

    <p class= "store_show_list_font">住所</p>
    <li class="list-group-item"><%= [@store.prefecture.name, @store.address].join(" ") %></li>

    <p class= "store_show_list_font">生産国</p>
    <li class="list-group-item"><%= @store.countries%></li>

    <p class= "store_show_list_font">焙煎度</p>
    <li class= "list-group-item">
      <% @store.roast_level.times do %>
        <span class="coffeebeans_icon"></span>
      <% end %>
    </li>
  </ul>
  <p>登録者: <%= link_to @store.user.name, user_path(@store.user), class: "user-link" %> </p>
  <p>最終更新: <%= @store.updated_at.strftime("%Y-%m-%d") %> </p>
</div>

  <% if user_signed_in? %>
    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <%= link_to "店舗情報編集 →", [:edit, @store], class: "btn btn-light btn-store-edit" %>
      <% if current_user && current_user == @store.user %>
        <%= link_to '店舗を削除', store_path(@store), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-danger' %>
      <% end %>
    </div>
  <% end %>

<h2 class="text-center mb-4">レビュー</h2>

<div class="d-flex justify-content-center">
  <div class="card shadow-sm p-4">
    <% avg = @store.average_rating.round if @store.average_rating.present? %>
    <div class="text-center mb-4">
      <% if avg.present? %>
        <p class="mb-1">平均評価</p>
        <div class="fs-4">
          <% avg.times do %>
            <span class="text-warning">★</span>
          <% end %>
          <% (5 - avg).times do %>
            <span class="text-secondary">☆</span>
          <% end %>
          <span class="ms-2">(<%= @store.average_rating.round(1) %>)</span>
        </div>
      <% else %>
        <p class="text-muted">まだ評価はありません</p>
      <% end %>
    </div>

    <% if @store.reviews.any? %>
      <div class="row row-cols-1 row-cols-md-2 g-4">
        <% @store.reviews.each do |review| %>
          <div class="col">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h5 class="card-title"><strong><%= link_to review.user.name, user_path(review.user), class: "user-link" %></strong> さん</h5>
                <p class="text-muted">投稿日: <%= review.created_at.strftime("%Y/%m/%d") %></p>
                <div class="text-warning mb-2">
                  <% review.rating.times do %>
                    ★
                  <% end %>
                  <% (5 - review.rating).times do %>
                    ☆
                  <% end %>
                </div>
                <p class="card-text"><%= review.comment %></p>
              </div>
              <% if current_user && current_user == review.user %>
                <div class="card-footer d-flex gap-2">
                  <%= link_to 'レビュー編集', edit_store_review_path(@store, review), class: "btn btn-sm btn-outline-success " %>
                  <%= link_to 'レビュー削除', store_review_path(@store, review), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-sm btn-outline-danger' %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-center">まだレビューがありません。</p>
    <% end %>

    <div class="text-center mt-4">
      <% if user_signed_in? %>
        <%= link_to 'レビューを投稿する', new_store_review_path(@store), class: "btn btn-success" %>
      <% else %>
        <p>レビューを投稿するには <%= link_to 'ログイン', new_user_session_path %> してください。</p>
      <% end %>
    </div>
  </div>
</div>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_KEY'] %>&libraries=maps,marker&callback=initMap">
</script>

<script>
  function initMap() {
    var storeLocation = { lat: <%= @store.latitude %>, lng: <%= @store.longitude %> };

    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15,
      center: storeLocation
    });

    const marker = new google.maps.Marker({
      position: storeLocation,
      map: map
    });
    window.markers = [marker];

    const infoWindow = new google.maps.InfoWindow({
      content: "<%= @store.name %>"
    });

    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });
  }
</script>